version: '3.8'

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"
    tag: "{{.Name}}"

x-defaults: &default-app-config
  restart: unless-stopped
  logging: *default-logging
  networks:
    - media-network
  # NO user directive - entrypoint handles privilege drop

services:
  media-resolver:
    <<: *default-app-config
    image: media-resolver:latest
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: media-resolver
    ports:
      - "${HOST_PORT:-8000}:8000"
    environment:
      # Server
      - HOST=0.0.0.0
      - PORT=8000
      - WORKERS=${WORKERS:-auto}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # Security
      - JWT_SECRET=${JWT_SECRET:-}
      - TOKEN_EXPIRE_MINUTES=${TOKEN_EXPIRE_MINUTES:-30}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      
      # Features
      - HAS_FFMPEG=${ENABLE_FFMPEG:-true}
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-500}
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-3600}
      
      # Redis
      - REDIS_URL=redis://redis:6379/0
      
      # Domain
      - DOMAIN=${DOMAIN:-media.localhost}
    volumes:
      - media-data:/app/data
      - media-logs:/app/logs
      - media-cache:/app/cache
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.media-resolver.rule=Host(`${DOMAIN:-media.localhost}`)"
      - "traefik.http.services.media-resolver.loadbalancer.server.port=8000"

  redis:
    image: redis:7-alpine
    container_name: media-resolver-redis
    command: >
      redis-server 
      --appendonly yes
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - media-network
    restart: unless-stopped
    user: "999:999"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  media-data:
    driver: local
  media-logs:
    driver: local
  media-cache:
    driver: local
  redis-data:
    driver: local

networks:
  media-network:
    driver: bridge